name: Cleanup Old Artifacts and Caches

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  cleanup-artifacts:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 5

      - name: Delete old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '30 days'
          skip-recent: 5

  cleanup-docker-images:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    
    steps:
      - name: Delete untagged container images
        uses: actions/delete-package-versions@v4
        with:
          package-name: 'midora-solid-ai'
          package-type: 'container'
          min-versions-to-keep: 5
          delete-only-untagged-versions: 'true'

      - name: Delete old tagged versions (keep last 10)
        uses: actions/delete-package-versions@v4
        with:
          package-name: 'midora-solid-ai'
          package-type: 'container'
          min-versions-to-keep: 10
          ignore-versions: '^(latest|main|v\d+\.\d+\.\d+)$'

  cleanup-caches:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Cleanup old caches
        run: |
          echo "Listing caches..."
          gh extension install actions/gh-actions-cache
          
          REPO="${{ github.repository }}"
          
          # Get all caches older than 7 days
          gh actions-cache list -R $REPO --limit 100 | while read -r line; do
            CACHE_KEY=$(echo "$line" | awk '{print $1}')
            CACHE_AGE=$(echo "$line" | awk '{print $3}')
            
            # Parse age and delete if older than 7 days
            if [[ "$CACHE_AGE" =~ ([0-9]+)d ]]; then
              DAYS="${BASH_REMATCH[1]}"
              if [ "$DAYS" -gt 7 ]; then
                echo "Deleting cache: $CACHE_KEY (${DAYS} days old)"
                gh actions-cache delete "$CACHE_KEY" -R $REPO --confirm
              fi
            fi
          done
        env:
          GH_TOKEN: ${{ github.token }}
